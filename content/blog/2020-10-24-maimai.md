---
title: äºŒæ¬¡å…ƒçœ‹è¿‡æ¥ï¼åŸºäº Serverless çš„èˆèŒéŸ³æ¸¸æŸ¥åˆ†å™¨
description: Serverless å’ŒéŸ³ä¹æ¸¸æˆè¹¦å‡ºæ–°ç«èŠ±ğŸ”¥
date: 2020-10-24
thumbnail: https://img.serverlesscloud.cn/2020115/1604567602988-WX20201105-160934.jpg
categories:
  - user-stories
authors:
  - è¿œå“¥åˆ¶é€ 
authorslink:
  - https://www.yuangezhizao.cn/articles/python/flask/serverless/maimai_DX_CN_probe.html
tags:
  - Serverless
  - äºŒæ¬¡å…ƒ
---

## å‰è¨€

ç¤¾ç•œä¸‹ç­æ—¶åˆ·å¾®ä¿¡æ—¶çœ‹åˆ°äº†[Serverless æœ‰ä¸€ç™¾ç§ç©æ³•ï¼Œæ¯”å¥½ç©æ›´å¥½ç©](https://web.archive.org/web/20201020122345/https://mp.weixin.qq.com/s/jaCLx6gn3aHbLLptXvqsLQ)è¿™ç¯‡æ¨é€ï¼Œæ­£å·§è‡ªå·±æœ€è¿‘æ–­æ–­ç»­ç»­åœ¨å†™éŸ³æ¸¸çš„å†å²è®°å½•å­˜æ¡£ï¼Œè¶ç€è¿™ä¸ªæœºä¼šå†³å®šå‚åŠ è¿™æ¬¡åº”ç”¨å¼€å‘ã€‚

**ä¸€ã€ä»€ä¹ˆæ˜¯ Serverless Framework**

> `Serverless Framework` æ˜¯ä¸šç•Œéå¸¸å—æ¬¢è¿çš„æ— æœåŠ¡å™¨åº”ç”¨æ¡†æ¶ï¼Œå¼€å‘è€…æ— éœ€å…³å¿ƒåº•å±‚èµ„æºå³å¯éƒ¨ç½²å®Œæ•´å¯ç”¨çš„ `Serverless` åº”ç”¨æ¶æ„ã€‚`Serverless Framework` å…·æœ‰èµ„æºç¼–æ’ã€è‡ªåŠ¨ä¼¸ç¼©ã€äº‹ä»¶é©±åŠ¨ç­‰èƒ½åŠ›ï¼Œè¦†ç›–ç¼–ç ã€è°ƒè¯•ã€æµ‹è¯•ã€éƒ¨ç½²ç­‰å…¨ç”Ÿå‘½å‘¨æœŸï¼Œå¸®åŠ©å¼€å‘è€…é€šè¿‡è”åŠ¨äº‘èµ„æºï¼Œè¿…é€Ÿæ„å»º `Serverless` åº”ç”¨

æ²¡é”™ï¼Œå°±åƒå‡ å¤©å‰çœ‹åˆ°çš„ã€ŠServerless ä¹‹æ­Œã€‹é‡Œé¢æ‰€è¯´ `I'm gonna reduce your ops`ï¼Œå®ƒèƒ½å¤§å¹…åº¦å‡è½»è¿ç»´å‹åŠ›ï¼Œé‚£å°±å¼€å§‹åŠ¨æ‰‹å§ï¼æ³¨æ„å¼€å‘ç¯å¢ƒéœ€ `Node.js 10.0+`ï¼Œä¸€é”®å…¨å±€å®‰è£…ï¼š`npm install -g serverless`

**äºŒã€è…¾è®¯äº‘ Flask Serverless Component ç®€ä»‹**

> è…¾è®¯äº‘ `Flask Serverless Component`ï¼Œæ”¯æŒ `Restful API` æœåŠ¡çš„éƒ¨ç½²

æŒ‰ç…§æƒ¯ä¾‹é¦–å…ˆæ¥éƒ¨ç½² `demo` å§

1. æœ¬åœ° `PyCharm` åˆ›å»ºä¸€ä¸ªæ–°çš„ `Flask` é¡¹ç›®

![Flask](https://img.serverlesscloud.cn/20201111/1605082790529-QQ20201020-212721%402x.png%21webp)

2. æ‰‹åŠ¨åˆ›å»ºå†…å®¹ä¸º `Flask` çš„ `requirements.txt`

3. æŒ‰ç…§[é…ç½®æ–‡æ¡£](https://github.com/serverless-components/tencent-flask/blob/master/docs/configure.md)åˆ›å»º `serverless.yml`ï¼Œä¾‹å¦‚æœ¬é¡¹ç›®å®é™…ä½¿ç”¨çš„å®Œæ•´å†…å®¹ï¼Œåˆæ¬¡ä½¿ç”¨å¯è‡ªè¡Œé…Œæƒ…ç®€åŒ–

4. å°†å¯†åŒ™å†™å…¥ `.env`ï¼ˆå½“ç„¶ï¼Œéƒ¨ç½²çš„æ—¶å€™ä¹Ÿå¯ä»¥é€‰æ‹©å¾®ä¿¡æ‰«ç æˆæƒï¼‰

``` bash
TENCENT_SECRET_ID=<rm>
TENCENT_SECRET_KEY=<rm>
```

![æˆåŠŸéƒ¨ç½²](https://img.serverlesscloud.cn/20201111/1605082869319-QQ20201020-225316%402x.png%21webp)

![æˆåŠŸè®¿é—®](https://img.serverlesscloud.cn/20201111/1605082907209-QQ20201020-230006%402x.png%21webp)

è¿™æ ·åŸºäº `Serverless` çš„ `Flask Demo` å°±éƒ¨ç½²å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥ç»§ç»­æŒ‰ç…§è‡ªå·±çš„æ–¹å¼å†™å‰©ä¸‹çš„ä»£ç ã€‚

**ä¸‰ã€maimai_DX**

[maimai](https://mzh.moegirl.org.cn/zh-hans/Maimaiç³»åˆ—) æ˜¯ä¸€æ¬¾è¡—æœºéŸ³æ¸¸ã€‚

![](https://img.serverlesscloud.cn/2020115/1604563824205-WX20201105-160934%402x.jpg)

åœ¨è¿™é‡Œæ”¾ä¸€å¼ åŠ¨å›¾è‡ªè¡Œä½“ä¼šä¸€ä¸‹ï¼ŒåŸå§‹ç´ ææ¥è‡ª[ã€Œå¤–å½• maimaiã€QZKago Requiem Re:MASTER ALLPERFECT Player: Ruri*R](https://www.bilibili.com/video/av457219654)

![QZKago](https://i1.yuangezhizao.cn/macOS/QQ20201024-213604-HD.gif!webp)

> - [æ—¥æœ¬å®˜ç½‘](https://maimai.sega.jp/)
> - [æµ·å¤–å®˜ç½‘](https://maimai.sega.com/)

åœ¨å›½å†…ï¼Œåªèƒ½ä»å¾®ä¿¡å…¬ä¼—å·ä¸­æŸ¥çœ‹æˆç»©ï¼Œè€Œä¸”æ¯æ¬¡è¿›é¡µé¢éƒ½éœ€è¦å¾®ä¿¡çš„æˆæƒç™»å½•ï¼Œå¹¶ä¸”é‡Œé¢å­˜å‚¨çš„è®°å½•æœ‰æ¡æ•°é™åˆ¶ï¼Œ`ç›¸å†Œ`åªå­˜æœ€æ–° 10 æ¡ï¼Œ`æ¸¸æˆè®°å½•`åªå­˜æœ€æ–° 50 æ¡ï¼ˆå°±æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå…ˆè¿›å…ˆå‡ºçš„é‚£ç§ï¼‰ã€‚è¿™å°±æ˜¯æœ¬é¡¹ç›®çš„åˆè¡·ï¼Œè‡ªå·±æ‰“å‡ºæ¥çš„æ¯ä¸€æ¬¡æˆç»©éƒ½åº”è¯¥ä¿å­˜å¥½ã€‚

## èˆèŒæŸ¥åˆ†å™¨

æˆæœå±•ç¤ºäº†ï¼Œå‰ç«¯ `Fomantic-UI`ï¼Œåç«¯ `Flask`+`MySQL`ã€‚`gh` å¼€æºåœ°å€ï¼š[https://github.com/yuangezhizao/maimai_DX_CN_probe](https://github.com/yuangezhizao/maimai_DX_CN_probe)ï¼Œæ¬¢è¿ `watch`ã€`star`ã€`fork` & `pr`ï¼

![https://maimai.yuangezhizao.cn](https://i1.yuangezhizao.cn/macOS/QQ20200515-185154@2x.png!webp)

ç›®å‰å®è£…äº†å¦‚ä¸‹åŠŸèƒ½ï¼š

1. [wechat_archive](https://maimai.yuangezhizao.cn/wechat_archive)ä¸­åŒ…å« `ä¸»é¡µ`ï¼Œ`æ¸¸æˆæ•°æ®`ï¼Œ`ç›¸å†Œ` å’Œ `æ¸¸æˆè®°å½•`ï¼šå¯¹åŸå§‹ç½‘é¡µè¿›è¡Œäº†ä¿®æ”¹ï¼Œå¹¶ä¸”æ·»åŠ äº† `Highcharts` åº“å¯è§†åŒ–æ›²çº¿æ˜¾ç¤ºå˜åŒ–
2. [record](https://maimai.yuangezhizao.cn/record)åŒ…å« `è®°å½•ï¼ˆåˆ†é¡µï¼‰` å’Œ `å·®å¼‚ï¼ˆåˆ†é¡µï¼‰`ï¼šå³è‡ªå†™çš„å¿«é€Ÿé¢„è§ˆé¡µé¢ï¼Œæ˜¯æŸ¥çœ‹å†å²è®°å½•å’Œæˆç»©å˜åŒ–çš„éå¸¸å®ç”¨çš„åŠŸèƒ½
3. [info](https://maimai.yuangezhizao.cn/info)åŒ…å« `é“ºé¢åˆ—è¡¨`ï¼šå³å…¨éƒ¨é“ºé¢åŸºç¡€ä¿¡æ¯ï¼Œè¾“å‡ºåˆ°ä¸€ä¸ªé¡µé¢ä¸­ï¼Œæ–¹ä¾¿é¡µé¢å†…æœç´¢

## å¼€å‘è¿‡ç¨‹

æ¥ä¸‹æ¥å°†æŒ‰ç…§æ—¶é—´çš„é¡ºåºï¼Œæè¿°ä¸€ä¸‹å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä»¥åŠå¦‚ä½•è§£å†³

### 1. `Serverless Framework Component` é…ç½®æ–‡ä»¶

`Serverless Framework` ç°åœ¨æ˜¯ `V2` ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸èƒ½æ²¿è¢­ä¹‹å‰ç‰ˆæœ¬çš„ `serverless.yml` é…ç½®æ–‡ä»¶ï¼Œéœ€è¦é‡æ–°å¯¹ç…§æ–‡æ¡£ä¿®æ”¹ã€‚

a. ä¹‹å‰ç‰ˆæœ¬ä¼šæ ¹æ® `requirements.txt` è‡ªåŠ¨ä¸‹è½½ç¬¬ä¸‰æ–¹åº“åˆ°é¡¹ç›®ç›®å½•ä¸‹çš„ `.serverless` æ–‡ä»¶å¤¹ä¸‹çš„ `requirements` æ–‡ä»¶å¤¹ä»¥å‚åŠ æœ€ç»ˆçš„ä¾èµ–æ‰“åŒ…ï¼Œå‹ç¼©æˆ `zip` æ–‡ä»¶å†æœ€ç»ˆä¸Šä¼ è‡³äº‘å‡½æ•°è¿è¡Œç¯å¢ƒ

b. æœ€æ–°ç‰ˆæœ¬ä¸å†è‡ªåŠ¨ä¸‹è½½ï¼Œéœ€è¦è‡ªè¡Œå¤„ç†ã€‚å®˜æ–¹ç¤ºä¾‹çš„å‚è€ƒç”¨æ³•ï¼š[hook](https://github.com/serverless-components/tencent-flask/blob/49bc914fad091bad9202ac481042760509342b3d/example/serverless.yml#L8-L17)

``` yml
  src:
    # TODO: å®‰è£…pythoné¡¹ç›®ä¾èµ–åˆ°é¡¹ç›®å½“å‰ç›®å½•
    hook: 'pip3 install -r requirements.txt -t ./requirements'
    dist: ./
    include:
      - source: ./requirements
        prefix: ../ # prefix, can make ./requirements files/dir to ./
    exclude:
      - .env
      - 'requirements/**'
```

æ³¨é‡Šå†™çš„å¾ˆæ¸…æ¥šï¼Œä½¿ç”¨ `hook` å»æ ¹æ® `requirements.txt` ä¸‹è½½ç¬¬ä¸‰æ–¹åº“åˆ°é¡¹ç›®ç›®å½•ä¸‹çš„ `requirements` æ–‡ä»¶å¤¹ï¼Œé¿å…ç¬¬ä¸‰æ–¹åº“å¯¼è‡´æœ¬åœ°æ–‡ä»¶å¤¹ç®¡ç†æ··ä¹±ã€‚ç„¶å `include` ä¸­æŒ‡å®šäº†é¡¹ç›®ç›®å½•ä¸‹çš„ `requirements` æ–‡ä»¶å¤¹åœ¨äº‘ç«¯çš„ `prefix`ï¼Œå³å¯¹äºäº‘ç«¯çš„äº‘å‡½æ•°è¿è¡Œç¯å¢ƒï¼Œ`requirements` æ–‡ä»¶å¤¹ä¸­çš„ç¬¬ä¸‰æ–¹åº“å’Œé¡¹ç›®ç›®å½•æ˜¯åŒçº§çš„ï¼Œå¯ä»¥æ­£å¸¸å¯¼å…¥ä½¿ç”¨ã€‚å½“ç„¶äº†ï¼Œæœ¬åœ°è¿è¡Œä½¿ç”¨çš„æ˜¯å…¨å±€çš„ç¬¬ä¸‰æ–¹åº“ï¼Œå¹¶æœªç”¨åˆ°é¡¹ç›®ç›®å½•ä¸‹çš„ `requirements` æ–‡ä»¶å¤¹ã€‚

### 2. å±‚ç®¡ç†æ¦‚è¿°

å‰è€…ï¼ˆæŒ‡ bï¼‰æ˜¯ä¸€ä¸ªå¾ˆåˆç†çš„è®¾è®¡ï¼Œä¸è¿‡åœ¨å®é™…ç¯å¢ƒä¸­å´å‘ç°äº†æ–°çš„é—®é¢˜ã€‚å®Œå…¨ä¸€è‡´çš„é…ç½®æ–‡ä»¶

``` yml
  src:
    hook: 'pip3 install -r ./src/requirements.txt -t ./src/requirements'
    dist: ./src
    include:
      - source: ./requirements
        prefix: ../
    exclude:
      - .env
```

åœ¨ macOS ä¸‹æˆåŠŸéƒ¨ç½²ä¹‹åï¼Œäº‘ç«¯çš„äº‘å‡½æ•°ç¼–è¾‘å™¨ä¸­çœ‹åˆ° `requirements` æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œç¬¬ä¸‰æ–¹åº“å’Œé¡¹ç›®ç›®å½•æ˜¯åŒçº§çš„ï¼Œçš„ç¡®æ²¡é—®é¢˜ã€‚

ä¸è¿‡åœ¨ Windows ä¸‹æˆåŠŸéƒ¨ç½²ä¹‹åï¼Œäº‘ç«¯çš„äº‘å‡½æ•°ç¼–è¾‘å™¨ä¸­çœ‹åˆ°äº† `requirements` æ–‡ä»¶å¤¹ï¼Ÿä¹Ÿå°±æ˜¯è¯´ç¬¬ä¸‰æ–¹åº“å’Œé¡¹ç›®ç›®å½•éåŒçº§ï¼Œäºæ˜¯è®¿é—®å°±ä¼šå‡ºç° `no module found` çš„å¯¼å…¥æŠ¥é”™äº†â€¦â€¦

åå¤å°è¯•ä¿®æ”¹ `prefix` ç­‰é…ç½®é¡¹åˆ°æœ€åä¹Ÿæ²¡æœ‰è°ƒè¯•æˆåŠŸï¼Œå› æ­¤åœ¨è¿™é‡Œæå‡ºä¸¤ç§è§£å†³æ–¹æ³•ï¼š

a. ä¿®æ”¹é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼Œè®©æœ¬åœ°çš„ç¬¬ä¸‰æ–¹åº“å’Œé¡¹ç›®ç›®å½•åŒçº§å­˜åœ¨

``` yml
  src:
    hook: 'pip3 install -r ./src/requirements.txt -t ./src'
    dist: ./src
    exclude:
      - .env
```

ä¸è¿‡éšç€é¡¹ç›®å’Œç¬¬ä¸‰æ–¹åº“çš„æ‰©å¤§æ–‡ä»¶å¤¹ä¼šè¶Šæ¥è¶Šå¤šï¼Œéå¸¸ä¸ä¾¿äºç®¡ç†

b. ä½¿ç”¨äº‘å‡½æ•°æä¾›çš„ `å±‚`

è™½ç„¶ `sls deploy` éƒ¨ç½²çš„é€Ÿåº¦å¾ˆå¿«ï¼Œä½†æ˜¯å¦‚æœå¯ä»¥åœ¨éƒ¨ç½²æ—¶åªä¸Šä¼ é¡¹ç›®ä»£ç è€Œä¸å»å¤„ç†ä¾èµ–ä¸å°±æ›´å¥½äº†å˜›ï¼Œè¿™æ ·è·¨ç»ˆåä½œç«¯å¼€å‘åªéœ€è¦å…³å¿ƒé¡¹ç›®ä»£ç å°± `ok` äº†ï¼Œå†ä¹Ÿä¸éœ€è¦ç®¡ç†ä¾èµ–ï¼

å¹¶ä¸”è¿˜æœ‰ä¸€ç‚¹ï¼Œæƒ³åœ¨ `SCF` æ§åˆ¶å°ä¸­åœ¨çº¿ç¼–è¾‘å‡½æ•°ä»£ç éœ€è¦å°†éƒ¨ç½²ç¨‹åºåŒ…ä¿æŒåœ¨ `10MB` ä»¥ä¸‹ï¼Œä¸è¦ä»¥ä¸ºåå…†å¾ˆå¤§ï¼Œå¾ˆå¿«å°±ç”¨å…‰ä¹Ÿæ˜¯å¯èƒ½çš„

![ä»…æ˜¾ç¤ºå…¥å£æ–‡ä»¶](https://i1.yuangezhizao.cn/macOS/QQ20201022-210610@2x.png!webp)

å…·ä½“å¦‚ä½•æ“ä½œå‘¢ï¼Ÿé‚£å°±æ˜¯è¦å°†ç¬¬ä¸‰æ–¹åº“æ–‡ä»¶å¤¹ç›´æ¥æ‰“åŒ…å¹¶åˆ›å»ºä¸ºå±‚ï¼Œåˆ™åœ¨å‡½æ•°ä»£ç ä¸­å¯ç›´æ¥é€šè¿‡ `import` å¼•ç”¨ï¼Œæ¯•ç«Ÿæœ‰äº›ç‰¹æ®Šåº“æ¯”å¦‚ `Brotli`ï¼ŒWindows ä¸‹æ²¡æœ‰ `vc++` çš„è¯å°±åªèƒ½å»[https://lfd.uci.edu/~gohlke/pythonlibs](https://lfd.uci.edu/~gohlke/pythonlibs)ä¸‹è½½ `wheel` å®‰è£…ã€‚

macOS ä¸‹æ­£å¸¸å®‰è£…ä¹‹åä¼šå¾—åˆ° `_brotli.cpython-39-darwin.so`ï¼Œ`brotli.py` ä¸­å†ä»¥ `import _brotli` çš„å½¢å¼å¯¼å…¥ï¼Œä¸è¿‡åˆå‡ºæ–°é—®é¢˜äº†ï¼Œäº‘ç«¯ä¼šå¯¼å…¥æŠ¥é”™`ModuleNotFoundError: No module named '_brotli'"`

> å½“å‰ `SCF` çš„æ‰§è¡Œç¯å¢ƒå»ºç«‹åœ¨ä»¥ä¸‹åŸºç¡€ä¸Šï¼šæ ‡å‡† `CentOS 7.2`

ä¸ºäº†è§£å†³é—®é¢˜å°è¯•åœ¨ linux ç¯å¢ƒä¸‹æ‰“åŒ…ï¼Œæ‹¿èµ·æ‰‹å¤´çš„ `CentOS 8.2` äº‘ä¸»æœºå¼€å§‹æ“ä½œ

``` bash
pip3 install -r requirements.txt -t ./layer --upgrade
zip -r layer.zip ./layer
```

ç„¶åå°±å¯ä»¥æŠŠæ‰“åŒ…çš„ `layer.zip` ä¸‹è½½åˆ°æœ¬åœ°å†ä¼ ä¸Šå»äº†ï¼Œæš‚æ—¶å¯ä»¥ä¸€åŠ³æ°¸é€¸äº†ã€‚

![å±‚è¯¦ç»†ä¿¡æ¯](https://i1.yuangezhizao.cn/macOS/QQ20201022-234808@2x.png!webp)

å¯¹äº†ï¼Œé…ç½®æ–‡ä»¶å¯ä»¥ç§»é™¤ `hook` å¹¶æ·»åŠ  `layers` äº†

``` yml
  src:
    src: ./src
    exclude:
      - .env
      - '__pycache__/**'
  layers:
    - name: maimai_DX_CN_probe
      version: 3
```

> å·²ç»‘å®šå±‚çš„å‡½æ•°è¢«è§¦å‘è¿è¡Œï¼Œå¯åŠ¨å¹¶å‘å®ä¾‹æ—¶ï¼Œå°†ä¼šè§£å‹åŠ è½½å‡½æ•°çš„è¿è¡Œä»£ç è‡³ `/var/user/` ç›®å½•ä¸‹ï¼ŒåŒæ—¶ä¼šå°†å±‚å†…å®¹è§£å‹åŠ è½½è‡³ `/opt` ç›®å½•ä¸‹ã€‚è‹¥éœ€ä½¿ç”¨æˆ–è®¿é—®çš„æ–‡ä»¶ `file`ï¼Œæ”¾ç½®åœ¨åˆ›å»ºå±‚æ—¶å‹ç¼©æ–‡ä»¶çš„æ ¹ç›®å½•ä¸‹ã€‚åˆ™åœ¨è§£å‹åŠ è½½åï¼Œå¯ç›´æ¥é€šè¿‡ç›®å½• `/opt/file` è®¿é—®åˆ°è¯¥æ–‡ä»¶ã€‚è‹¥åœ¨åˆ›å»ºå±‚æ—¶ï¼Œé€šè¿‡æ–‡ä»¶å¤¹è¿›è¡Œå‹ç¼© `dir/file`ï¼Œåˆ™åœ¨å‡½æ•°è¿è¡Œæ—¶éœ€é€šè¿‡ `/opt/dir/file` è®¿é—®å…·ä½“æ–‡ä»¶

ä½“éªŒæ›´å¿«çš„éƒ¨ç½²é€Ÿåº¦å§ï¼å› ä¸ºç¬¬ä¸‰æ–¹åº“å·²ç»æ‰“åŒ…åœ¨â€œå±‚â€ä¸­äº†


ä½†æ˜¯å¥‡æ€ªçš„æ˜¯ï¼Œåœ¨äº‘ç«¯å¯¼å…¥ä»»æ„ç¬¬ä¸‰æ–¹åº“å‡ä¼šæŠ¥é”™ï¼Œäºæ˜¯è°ƒè¯•ç€æŸ¥çœ‹ `path`

``` bash
for path in sys.path:
    print(path)

/var/runtime/python3
/var/user
/opt
/var/lang/python3/lib/python36.zip
/var/lang/python3/lib/python3.6
/var/lang/python3/lib/python3.6/lib-dynload
/var/lang/python3/lib/python3.6/site-packages
/var/lang/python3/lib/python3.6/site-packages/pip-18.0-py3.6.egg
```

å†æŸ¥çœ‹ `opt`

``` bash
import os
dirs = os.listdir('/opt')

for file in dirs:
   print(file)

layer
```

è¿™æ‰æç„¶å¤§æ‚Ÿï¼Œ**æ‰“åŒ…æ—¶éœ€è¦åœ¨å½“å‰è·¯å¾„ç›´æ¥æ‰“åŒ…**ã€‚ä¸Šä¼ ä¹‹åâ€œå±‚â€æ›´æ–°ä¸ºç‰ˆæœ¬ `2`ï¼Œä½†æ˜¯ `ModuleNotFoundError: No module named '_brotli'` æŠ¥é”™ä¾æ—§ï¼Œå¹¶ä¸”ç¡®è®¤ `_brotli.cpython-38-x86_64-linux-gnu.so` æ–‡ä»¶å®é™…å­˜åœ¨ã€‚

è€Œåœ¨ `CentOS` å’Œ `macOS` ä¸Šæœ¬åœ°å¯¼å…¥å‡æ²¡æœ‰é—®é¢˜ï¼Œè¿™å¯å°±çŠ¯éš¾äº†ï¼Œåˆæƒ³åˆ°å¾ˆæœ‰å¯èƒ½æ˜¯ `python` ç‰ˆæœ¬çš„é—®é¢˜ï¼Œäºæ˜¯å»å¯»æ‰¾ç°æˆ `3.6` çš„ç¯å¢ƒï¼Œæ¯”å¦‚è¿™é‡Œï¼š

![3.6.8](https://i1.yuangezhizao.cn/macOS/QQ20201022-233709@2x.png!webp)

å†å†æ¬¡ä¸Šä¼ ä¹‹åâ€œå±‚â€æ›´æ–°ä¸ºç‰ˆæœ¬ `3`ï¼Œè®¿é—®æˆåŠŸï¼è¯¾é¢˜ç»ˆäºè§£å†³ï¼ŒåŸæ¥æ˜¯éœ€è¦**ç›¸åŒç‰ˆæœ¬**çš„ `Python 3.6` è¿è¡Œç¯å¢ƒ

### 3.è‡ªå®šä¹‰å…¥å£æ–‡ä»¶

[components](https://github.com/serverless-components)æºç [tencent-flask/src/_shims/](https://github.com/serverless-components/tencent-flask/tree/master/src/_shims)ä¸­çš„æ–‡ä»¶æ¯æ¬¡éƒ½ä¼šè¢«åŸå°ä¸åŠ¨åœ°é‡æ–°æ‰“åŒ…ä¸Šä¼ åˆ°äº‘ç«¯äº‘å‡½æ•°ä¸­ï¼Œç›®å‰æœ‰ä¸¤ä¸ªæ–‡ä»¶

a. `severless_wsgi.py`ï¼Œä½œç”¨æ˜¯ `converts an AWS API Gateway proxied request to a WSGI request.`
`WSGI`çš„å…¨ç§°æ˜¯`Python Web Server Gateway Interface`å³`Web æœåŠ¡å™¨ç½‘å…³æ¥å£`ï¼Œå®ƒæ˜¯ä¸º`Python`è¯­è¨€å®šä¹‰çš„`Web`æœåŠ¡å™¨å’Œ`Web`åº”ç”¨ç¨‹åºæˆ–æ¡†æ¶ä¹‹é—´çš„ä¸€ç§ç®€å•è€Œé€šç”¨çš„æ¥å£

b. `sl_handler.py`ï¼Œå°±æ˜¯é»˜è®¤çš„å…¥å£æ–‡ä»¶

``` python
import app  # Replace with your actual application
import severless_wsgi

# If you need to send additional content types as text, add then directly
# to the whitelist:
#
# serverless_wsgi.TEXT_MIME_TYPES.append("application/custom+json")

def handler(event, context):
    return severless_wsgi.handle_request(app.app, event, context)
```

é’ˆå¯¹äºè‡ªå·±çš„é¡¹ç›®ï¼Œä½¿ç”¨äº† `Flask` çš„ `å·¥å‚å‡½æ•°`ï¼Œä¸ºäº†é¿å…æ¯æ¬¡éƒ½è¦åœ¨äº‘ç«¯äº‘å‡½æ•°ç¼–è¾‘å™¨ä¸­é‡æ–°ä¿®æ”¹ï¼Œæœ€å¥½çš„æ–¹æ³•æ˜¯è‡ªå®šä¹‰å…¥å£æ–‡ä»¶ï¼š

``` python
import severless_wsgi

from maimai_DX_CN_probe import create_app  # Replace with your actual application


# If you need to send additional content types as text, add then directly
# to the whitelist:
#
# serverless_wsgi.TEXT_MIME_TYPES.append("application/custom+json")

def handler(event, context):
    return severless_wsgi.handle_request(create_app(), event, context)
```
å†æŒ‡å®š `æ‰§è¡Œæ–¹æ³•` ä¸º `serverless_handler.handler`ï¼Œå°± ok äº†

### 4. `url_for` è¾“å‡º `http` è€Œé `https` çš„ `URL`

åœ¨è§†å›¾å‡½æ•°ä¸­é‡å®šå‘åˆ° `url_for` æ‰€ç”Ÿæˆçš„é“¾æ¥éƒ½æ˜¯ `http`ï¼Œè€Œä¸æ˜¯ `https`â€¦â€¦å…¶å®è¿™ä¸ªé—®é¢˜ `Flask` çš„æ–‡æ¡£ [Standalone WSGI Containers](https://flask.palletsprojects.com/en/1.1.x/deploying/wsgi-standalone/)æœ‰æè¿°åˆ°

è¯´åˆ°åº•è¿™å¹¶ä¸æ˜¯ `Flask` çš„é—®é¢˜ï¼Œè€Œæ˜¯ `WSGI` ç¯å¢ƒæ‰€å¯¼è‡´çš„é—®é¢˜ï¼Œæ¨èçš„æ–¹æ³•æ˜¯ä½¿ç”¨**ä¸­é—´ä»¶**ï¼Œå®˜æ–¹ä¹Ÿç»™å‡ºäº† `ProxyFix`

``` python
from werkzeug.middleware.proxy_fix import ProxyFix
app.wsgi_app = ProxyFix(app.wsgi_app, x_proto=1, x_host=1)
```
ä½†æ˜¯æ˜¯ä»`X-Forwarded-Proto`ä¸­å–çš„å€¼ï¼Œ`apigw`ä¸­å…¶ä¸º`http`ï¼Œå› æ­¤å¹¶ä¸èƒ½ç›´æ¥ä½¿ç”¨è¿™ä¸ª`ProxyFix`
å› ä¸º`Flask`çš„ç¤¾åŒºè¿˜ç®—å®Œå–„ï¼Œå‚è€ƒèµ„æ–™å¾ˆå¤šå‰äººéƒ½é“ºå¥½äº†è·¯ï¼Œæ‰€ä»¥ç›´æ¥å»`Stack Overflow`æœè§£å†³æ–¹æ³•ï¼Œ[Flask url_for generating http URL instead of https](https://stackoverflow.com/questions/14810795/flask-url-for-generating-http-url-instead-of-https)
é—®é¢˜å‡ºç°çš„åŸå› å¦‚å›¾ï¼š`Browser ----- HTTPS ----> Reverse proxyï¼ˆapigwï¼‰ ----- HTTP ----> Flask`
å› ä¸ºè‡ªå·±åœ¨`apigw`è®¾ç½®äº†`å‰ç«¯ç±»å‹`ä»…`https`ï¼Œä¹Ÿå°±æ˜¯è¯´`Browser`ç«¯æ˜¯ä¸å¯èƒ½ä½¿ç”¨`http`è®¿é—®åˆ°çš„ï¼Œé€šè¿‡æ‰“å°`environ`å¯çŸ¥

``` json
{
  "CONTENT_LENGTH": "0",
  "CONTENT_TYPE": "",
  "PATH_INFO": "/",
  "QUERY_STRING": "",
  "REMOTE_ADDR": "",
  "REMOTE_USER": "",
  "REQUEST_METHOD": "GET",
  "SCRIPT_NAME": "",
  "SERVER_NAME": "maimai.yuangezhizao.cn",
  "SERVER_PORT": "80",
  "SERVER_PROTOCOL": "HTTP/1.1",
  "wsgi.errors": <__main__.CustomIO object at 0x7feda2224630>,
  "wsgi.input": <_io.BytesIO object at 0x7fed97093410>,
  "wsgi.multiprocess": False,
  "wsgi.multithread": False,
  "wsgi.run_once": False,
  "wsgi.url_scheme": "http",
  "wsgi.version": (1, 0),
  "serverless.authorizer": None,
  "serverless.event": "<rm>",
  "serverless.context": "<rm>",
  "API_GATEWAY_AUTHORIZER": None,
  "event": "<rm>",
  "context": "<rm>",
  "HTTP_ACCEPT": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9",
  "HTTP_ACCEPT_ENCODING": "gzip, deflate, br",
  "HTTP_ACCEPT_LANGUAGE": "zh-CN,zh;q=0.9,en;q=0.8",
  "HTTP_CONNECTION": "keep-alive",
  "HTTP_COOKIE": "<rm>",
  "HTTP_ENDPOINT_TIMEOUT": "15",
  "HTTP_HOST": "maimai.yuangezhizao.cn",
  "HTTP_SEC_FETCH_DEST": "document",
  "HTTP_SEC_FETCH_MODE": "navigate",
  "HTTP_SEC_FETCH_SITE": "none",
  "HTTP_SEC_FETCH_USER": "?1",
  "HTTP_UPGRADE_INSECURE_REQUESTS": "1",
  "HTTP_USER_AGENT": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36",
  "HTTP_X_ANONYMOUS_CONSUMER": "true",
  "HTTP_X_API_REQUESTID": "5bcb29af2ca18c1e6d7b1ec5ff7b5427",
  "HTTP_X_API_SCHEME": "https",
  "HTTP_X_B3_TRACEID": "5bcb29af2ca18c1e6d7b1ec5ff7b5427",
  "HTTP_X_QUALIFIER": "$LATEST"
}
```

`HTTP_X_FORWARDED_PROTO`å¯¹åº”`apigw`é‡Œçš„å˜é‡æ˜¯`HTTP_X_API_SCHEME`ï¼Œæ•…è§£å†³æ–¹æ³•å¦‚ä¸‹ï¼š[app.wsgi_app = ReverseProxied(app.wsgi_app)](https://github.com/yuangezhizao/maimai_DX_CN_probe/blob/4600b3d8212777cb6184c796c1967b3ea9b05997/src/maimai_DX_CN_probe/__init__.py#L36)

``` python
class ReverseProxied(object):
    def __init__(self, app):
        self.app = app

    def __call__(self, environ, start_response):
        scheme = environ.get('HTTP_X_FORWARDED_PROTO')
        if scheme:
            environ['wsgi.url_scheme'] = scheme
        return self.app(environ, start_response)

app = Flask(__name__)
app.wsgi_app = ReverseProxied(app.wsgi_app)
```

### 5. å“åº”æ•°æ®å‹ç¼©

ä¸è®ºæ˜¯`IIS`ã€`Apache`è¿˜æ˜¯`Nginx`ï¼Œéƒ½æä¾›æœ‰å‹ç¼©åŠŸèƒ½ã€‚æ¯•ç«Ÿè‡ªå·±åœ¨ç”¨çš„äº‘ä¸»æœºå¤–ç½‘ä¸Šè¡Œåªæœ‰`1M`å¸¦å®½ï¼Œå‹ç¼©åå¯¹äºç¼©çŸ­é¦–å±æ—¶é—´çš„æ•ˆæœæå‡æä¸ºæ˜¾è‘—ã€‚å¯¹äº`Serverless`ï¼Œå“åº”æ•°æ®æ˜¯é€šè¿‡`API Gateway`ä¼ è¾“åˆ°å®¢æˆ·ç«¯ï¼Œé‚£ä¹ˆå‹ç¼©ä¹Ÿåº”è¯¥æ˜¯å®ƒæ‰€å…·å¤‡çš„èƒ½åŠ›ï¼ˆè™½ç„¶å¤–ç½‘é€Ÿåº¦å¤§å¹…åº¦æé«˜ï¼Œä½†æ˜¯è¯¥å‹ç¼©è¿˜æ˜¯å¾—å‹ç¼©ï¼‰ï¼Œç„¶è€Œå¹¶æ²¡æœ‰æ‰¾åˆ°â€¦â€¦çœ‹åˆ°æŸäº›`js`æ¡†æ¶åŸç”Ÿæœ‰æä¾›å‹ç¼©åŠŸèƒ½ï¼Œäºæ˜¯æ‰“ç®—æ·»åŠ `Flask`è‡ªè¡Œå‹ç¼©çš„åŠŸèƒ½ã€‚ç®€å•æ¥è®²ï¼Œé€šè¿‡è®¢é˜…`@app.after_request`ä¿¡å·å¹¶è°ƒç”¨ç¬¬ä¸‰æ–¹åº“`brotli`çš„`compress`æ–¹æ³•å³å¯ï¼ˆ
åœ¨å†™ä¹‹å‰å»`gh`ä¸Šçœ‹çœ‹æœ‰æ²¡æœ‰ç°æˆçš„è½®å­æ‹“å±•ï¼Œæœç„¶æœ‰â€¦â€¦åˆšå¼€å§‹ç”¨çš„æ˜¯`Flask-Zipper`ï¼Œåæ¥æ¢æˆ`Flask-Compress`è§£å†³äº†é—®é¢˜
å®æµ‹`3.1 MB`çš„æ•°æ®é‡‡ç”¨`brotli`å‹ç¼©ç®—æ³•å‡è‡³`76.1 kB`

![å‹ç¼©å‰](https://i1.yuangezhizao.cn/macOS/QQ20201023-223613@2x.png!webp)

![å‹ç¼©å](https://i1.yuangezhizao.cn/macOS/QQ20201023-224633@2x.png!webp)

![br](https://i1.yuangezhizao.cn/macOS/QQ20201023-224722@2x.png!webp)


### 6. `apigw` ä¸‰ç§ç¯å¢ƒä¸åŒè·¯å¾„æ‰€äº§ç”Ÿçš„å½±å“

é»˜è®¤çš„æ˜ å°„å¦‚ä¸‹ï¼š

ID | ç¯å¢ƒå | è®¿é—®è·¯å¾„
:---: | :---: | :---:
1 | å‘å¸ƒ | release
2 | é¢„å‘å¸ƒ | prepub	
3 | æµ‹è¯• | test

å› ä¸ºé…ç½®çš„`static_url_path`ä¸º`""`ï¼Œå³`static`æ–‡ä»¶å¤¹æ˜¯æ˜ å°„åˆ°`/`è·¯å¾„ä¸‹çš„ï¼Œæ‰€ä»¥å†åŠ ä¸Š`release`ã€`prepub`å’Œ`test`è®¿é—®å°±è‡ªç„¶`404`äº†
å› æ­¤ç»‘å®šäº†`è‡ªå®šä¹‰åŸŸå`ï¼Œ`ä½¿ç”¨è‡ªå®šä¹‰è·¯å¾„æ˜ å°„`ï¼Œå¹¶å°†`å‘å¸ƒ`ç¯å¢ƒçš„è®¿é—®è·¯å¾„è®¾ç½®æˆ`/`ï¼Œè¿™æ ·å†è®¿é—®`å‘å¸ƒ`ç¯å¢ƒå°±æ²¡æœ‰é—®é¢˜äº†

ID | ç¯å¢ƒå | è®¿é—®è·¯å¾„
:---: | :---: | :---:
1 | å‘å¸ƒ | /
2 | é¢„å‘å¸ƒ | prepub	
3 | æµ‹è¯• | test

### 7. åŒæ—¶è®¿é—®`ç§æœ‰ç½‘ç»œ`å’Œ`å¤–ç½‘`

`äº‘å‡½æ•°`ä¸­å¯ä»¥åˆ©ç”¨åˆ°çš„äº‘ç«¯æ•°æ®åº“æœ‰å¦‚ä¸‹å‡ ç§

- äº‘æ•°æ®åº“`CDB`ï¼Œéœ€è¦`ç§æœ‰ç½‘ç»œ`è®¿é—®ï¼Œè™½ç„¶å¯ä»¥é€šè¿‡å¤–ç½‘è®¿é—®ä½†æ˜¯èƒ½èµ°å†…ç½‘å°±ä¸èµ°å¤–ç½‘
- `PostgreSQL for Serverlessï¼ˆServerlessDBï¼‰`ï¼Œè¿™ä¸ªæ˜¯å®˜æ–¹ç»™`Serverless`é…çš„`pg`æ•°æ®åº“
- äº‘å¼€å‘`TCB`ä¸­çš„`MongoDB`ï¼Œæ²¡è®°é”™çš„è¯éœ€è¦å¼€é€šå†…æµ‹æƒé™è®¿é—®

å› ä¸ºè‡ªå·±æ˜¯ä»æ—§ç½‘ç«™è¿ç§»è¿‡æ¥çš„ï¼Œæ•°æ®æš‚æ—¶è¿˜æ²¡æœ‰è¿ç§»ï¼Œå› æ­¤ç›´æ¥è®¿é—®åŸå§‹äº‘æ•°æ®åº“`CDB`ï¼Œåœ¨`äº‘å‡½æ•°`é…ç½®`æ‰€å±ç½‘ç»œ`å’Œ`æ‰€å±å­ç½‘`å³å¯ã€‚ä½†æ˜¯æ­¤æ—¶ä¼šæ— æ³•è®¿é—®å¤–ç½‘ï¼Œä¸€ç§è§£å†³æ–¹æ³•æ˜¯å¼€å¯`å…¬ç½‘è®¿é—®`å’Œ`å…¬ç½‘å›ºå®šIP`ï¼Œå°±å¯ä»¥åŒæ—¶è®¿é—®å†…ç½‘å’Œå¤–ç½‘èµ„æºäº†ã€‚å…³äºé…ç½®æ–‡ä»¶ï¼Œæœ¬é¡¹ç›®æ˜¯`å•å®ä¾‹åº”ç”¨`ä¹Ÿå°±æ˜¯è¯´`é¡¹ç›®ä¸­åªå¼•å…¥ä¸€ä¸ªç»„ä»¶ï¼Œéƒ¨ç½²æ—¶åªç”Ÿæˆä¸€ä¸ªç»„ä»¶å®ä¾‹`ã€‚ä½†æ˜¯å¦‚æœæƒ³å¼•å…¥æ•°æ®åº“çš„è¯ï¼Œå°±å¾—æ–°å¢ç»„ä»¶äº†ï¼Œç›®å‰åœ¨`Flask Components`ä¸­å¹¶æ²¡æœ‰æä¾›æ•°æ®åº“ç›¸å…³çš„é…ç½®é¡¹ï¼Œå› æ­¤éœ€è¦`é¡¹ç›®ä¸­å¼•å…¥å¤šä¸ªç»„ä»¶ï¼Œéƒ¨ç½²æ—¶ç”Ÿæˆå¤šä¸ªç»„ä»¶å®ä¾‹`ã€‚ä¹Ÿå¾ˆç®€å•ï¼Œåˆ›å»ºä¸€ä¸ªå«æœ‰`serverless.yml`çš„æ–°æ–‡ä»¶å¤¹ï¼Œç”¨æ¥é…ç½®`postgresql`

``` yml
component: postgresql # (å¿…å¡«) ç»„ä»¶åç§°ï¼Œæ­¤å¤„ä¸º postgresql
name: maimai_DX_CN_probe # (å¿…é€‰) ç»„ä»¶å®ä¾‹åç§°.
org: yuangezhizao # (å¯é€‰) ç”¨äºè®°å½•ç»„ç»‡ä¿¡æ¯ï¼Œé»˜è®¤å€¼ä¸ºæ‚¨çš„è…¾è®¯äº‘è´¦æˆ· appidï¼Œå¿…é¡»ä¸ºå­—ç¬¦ä¸²
app: yuangezhizao # (å¯é€‰) ç”¨äºè®°å½•ç»„ç»‡ä¿¡æ¯. é»˜è®¤ä¸nameç›¸åŒï¼Œå¿…é¡»ä¸ºå­—ç¬¦ä¸²
stage: dev # (å¯é€‰) ç”¨äºåŒºåˆ†ç¯å¢ƒä¿¡æ¯ï¼Œé»˜è®¤å€¼æ˜¯ dev

inputs:
  region: ap-beijing # å¯é€‰ ap-guangzhou, ap-shanghai, ap-beijing
  zone: ap-beijing-3 # å¯é€‰ ap-guangzhou-2, ap-shanghai-2, ap-beijing-3
  dBInstanceName: maimai_DX_CN_probe
  #  projectId: 0
  dBVersion: 10.4
  dBCharset: UTF8
  vpcConfig:
    vpcId: vpc-mrg5ak88
    subnetId: subnet-hqwa51dh
  extranetAccess: false
```

ç„¶ååœ¨ç»ˆç«¯`cd`åˆ°è¿™ä¸ªç›®å½•å†æ‰§è¡Œ`sls deploy`å³å¯æˆåŠŸéƒ¨ç½²`postgresql`

``` bash
yum install python3-devel postgresql-devel
pip install psycopg2
```

ç»“æœ

``` python
import psycopg2
File "/opt/psycopg2/__init__.py", line 51, in &lt;module&gt;
from psycopg2._psycopg import (                     # noqa
ImportError: libpython3.6m.so.1.0: cannot open shared object file: No such file or directory
```

ä¸‹åˆ—é—®é¢˜å¤„äºè§£å†³ä¹‹ä¸­ï¼š
- `http` å¼ºåˆ¶è·³è½¬ `https`
- æµ‹è¯•ç¯å¢ƒæ¨é€è‡³ç”Ÿäº§ç¯å¢ƒ

è‡³æ­¤ï¼Œæœ¬æ–‡å°±ç»“æŸäº†ï¼Œæ¬¢è¿[äº¤æµ](https://www.yuangezhizao.cn/articles/python/flask/serverless/maimai_DX_CN_probe.html)ï¼

---

æ¬¢è¿è®¿é—®ï¼š[Serverless ä¸­æ–‡ç½‘](https://serverlesscloud.cn/)ï¼Œæ‚¨å¯ä»¥åœ¨ [æœ€ä½³å®è·µ](https://serverlesscloud.cn/best-practice) é‡Œä½“éªŒæ›´å¤šå…³äº Serverless åº”ç”¨çš„å¼€å‘ï¼